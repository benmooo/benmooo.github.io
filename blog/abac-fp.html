<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/569ce4b8f30dc480-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/7833d2e2b2ee9543-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/93f479601ee12b01-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/f30152c0704fba31.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/0ae26d81c63a9da9.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/c79e2679a18ceb00.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/0e4ee5feb628e00d.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-5788873a3947c2cc.js"/><script src="/_next/static/chunks/4bd1b696-18452535c1c4862d.js" async=""></script><script src="/_next/static/chunks/684-a40553b8f97e5ad6.js" async=""></script><script src="/_next/static/chunks/main-app-08d8e87f5b019b96.js" async=""></script><script src="/_next/static/chunks/874-36030fac62063c21.js" async=""></script><script src="/_next/static/chunks/63-5ad18c88ec2f5164.js" async=""></script><script src="/_next/static/chunks/app/blog/%5Bslug%5D/page-ca6c25fdf74e0262.js" async=""></script><meta name="next-size-adjust" content=""/><title>函数式编程实现ABAC：关于DentFlex的权限控制 | 格物致知</title><meta name="description" content="探讨如何用函数式编程思维重新审视ABAC访问控制"/><meta name="keywords" content="ABAC,FP,权限控制"/><meta property="og:title" content="函数式编程实现ABAC：关于DentFlex的权限控制"/><meta property="og:description" content="探讨如何用函数式编程思维重新审视ABAC访问控制"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2025-1-12"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="函数式编程实现ABAC：关于DentFlex的权限控制"/><meta name="twitter:description" content="探讨如何用函数式编程思维重新审视ABAC访问控制"/><script>document.querySelectorAll('body link[rel="icon"], body link[rel="apple-touch-icon"]').forEach(el => document.head.appendChild(el))</script><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__variable_6d879b __variable_5cfdac __variable_9a8899 antialiased"><div class="min-h-screen bg-background text-foreground"><div class="max-w-2xl mx-auto px-4 py-12"><article><header class="mb-12"><div class="flex flex-wrap gap-2 mb-6"><span class="text-xs px-3 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded-lg">ABAC</span><span class="text-xs px-3 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded-lg">FP</span><span class="text-xs px-3 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded-lg">权限控制</span></div><h1 class="text-2xl md:text-4xl text-gray-900 dark:text-gray-100 mb-6 leading-tight">函数式编程实现ABAC：关于DentFlex的权限控制</h1><p class="font-light text-md text-gray-600 dark:text-gray-400 leading-relaxed mb-6 italic">探讨如何用函数式编程思维重新审视ABAC访问控制</p><div class="flex items-center text-sm text-gray-500 dark:text-gray-500"><time dateTime="2025-1-12">2025年1月12日</time></div><div class="w-16 h-px bg-gray-300 dark:bg-gray-600 mt-8"></div></header><article class="max-w-none prose prose-pink prose-img:rounded-lg prose-video:rounded-lg dark:prose-invert prose-a:text-foreground prose-a:decoration-6 prose-a:-underline-offset-2 prose-a:decoration-pink-300"><p>最近在开发DentFlex项目时，遇到了典型的权限控制场景。这是一个为即时义齿服务设计的数字平台，涉及牙科诊所、技师、服务协调员等多个角色，需要对外派服务订单、财务报表等资源进行精细化访问控制。</p>
<p>在传统的牙科义齿制作流程中，当患者需要种植牙时，牙医必须先拔除剩余牙齿并植入基台。在这个过渡期间，制造商会派遣技师提供即时临时义齿制作服务。过去这种协调主要依赖微信等非正式沟通渠道，效率低下且容易出错。</p>
<p>DentFlex要解决的就是这种混乱的协调问题。但随之而来的权限控制需求让我重新思考了ABAC的实现方式。</p>
<h2>复杂的权限需求</h2>
<p>在即时义齿服务场景中，权限控制远比简单的角色分配复杂：</p>
<ul>
<li><strong>牙科诊所</strong>可以创建服务请求，查看自己的订单状态，但不能修改已派发的订单</li>
<li><strong>技师</strong>可以接受指派，更新服务进度，上传完成照片，但只能操作分配给自己的订单</li>
<li><strong>服务协调员</strong>可以分配技师，修改订单状态，查看所有财务数据，但某些操作需要在工作时间内进行</li>
<li><strong>制造商管理员</strong>拥有最高权限，但对敏感财务数据的访问需要额外验证</li>
</ul>
<p>传统的RBAC显然不够用。权限不仅取决于用户角色，还与订单状态、时间、地理位置等多种因素相关。比如技师只能在订单状态为&quot;已派发&quot;时接受任务，服务协调员只能在工作时间调整高优先级订单。</p>
<h2>重新审视ABAC的本质</h2>
<p>看了一圈现有的ABAC实现方案，那些PIP、PDP、PEP组件让人眼花缭乱，静下心来想想，ABAC的核心其实很简单：</p>
<pre><code>决策 = f(用户属性, 资源属性, 环境属性, 操作属性)
</code></pre>
<p>这是一个纯函数，输入明确，输出确定，没有副作用。既然如此，为什么不直接用函数式编程来实现？</p>
<p>传统的组件化方式把这个简单的函数拆成了若干个类和接口，然后再把它们组合起来。就像把一个完整的服务订单切成片，装进不同的盒子里，最后再拼回去。</p>
<h2>属性收集：管道代替组件</h2>
<p>在传统ABAC中，PIP（策略信息点）负责收集属性。用函数式思维，这就是一个数据转换管道：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="dart" data-theme="github-dark-dimmed"><code data-language="dart" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#6CB6FF">Future</span><span style="color:#ADBAC7">&lt;</span><span style="color:#6CB6FF">Attributes</span><span style="color:#ADBAC7">&gt; </span><span style="color:#DCBDFB">collectServiceOrderAttributes</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#6CB6FF">  User</span><span style="color:#ADBAC7"> user,</span></span>
<span data-line=""><span style="color:#6CB6FF">  ServiceOrder</span><span style="color:#ADBAC7"> order</span></span>
<span data-line=""><span style="color:#ADBAC7">) </span><span style="color:#F47067">async</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#ADBAC7"> {}</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">withUser</span><span style="color:#ADBAC7">(user)</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">withServiceOrder</span><span style="color:#ADBAC7">(order)</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">withTimeContext</span><span style="color:#ADBAC7">()</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">withLocationContext</span><span style="color:#ADBAC7">();</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p>每个步骤都是一个纯函数，接收属性字典，返回增强后的字典。就像流水线一样，数据流经每个工站，逐步被加工完善。</p>
<p>在DentFlex中，我们需要根据用户角色、订单状态、服务时间、技师位置等因素来决定权限。这些属性散布在不同的数据源中，用管道模式可以优雅地组合它们：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="dart" data-theme="github-dark-dimmed"><code data-language="dart" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">extension</span><span style="color:#6CB6FF"> AttributePipeline</span><span style="color:#F47067"> on</span><span style="color:#6CB6FF"> Map</span><span style="color:#ADBAC7">&lt;</span><span style="color:#6CB6FF">String</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">dynamic</span><span style="color:#ADBAC7">&gt; {</span></span>
<span data-line=""><span style="color:#6CB6FF">  Map</span><span style="color:#ADBAC7">&lt;</span><span style="color:#6CB6FF">String</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">dynamic</span><span style="color:#ADBAC7">&gt; </span><span style="color:#DCBDFB">withUserRole</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">User</span><span style="color:#ADBAC7"> user) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">    ...</span><span style="color:#6CB6FF">this</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;user.role&#x27;</span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> user.role, </span><span style="color:#768390">// &#x27;clinic&#x27;, &#x27;technician&#x27;, &#x27;coordinator&#x27;, &#x27;admin&#x27;</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;user.region&#x27;</span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> user.assignedRegion,</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;user.certification&#x27;</span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> user.certificationLevel,</span></span>
<span data-line=""><span style="color:#ADBAC7">  };</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6CB6FF">  Map</span><span style="color:#ADBAC7">&lt;</span><span style="color:#6CB6FF">String</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">dynamic</span><span style="color:#ADBAC7">&gt; </span><span style="color:#DCBDFB">withServiceOrder</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">ServiceOrder</span><span style="color:#ADBAC7"> order) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">    ...</span><span style="color:#6CB6FF">this</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;order.status&#x27;</span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> order.status, </span><span style="color:#768390">// &#x27;pending&#x27;, &#x27;assigned&#x27;, &#x27;in_progress&#x27;, &#x27;completed&#x27;</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;order.priority&#x27;</span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> order.priority,</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;order.clinic_id&#x27;</span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> order.clinicId,</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;order.assigned_technician&#x27;</span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> order.assignedTechnicianId,</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;order.created_at&#x27;</span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> order.createdAt,</span></span>
<span data-line=""><span style="color:#ADBAC7">  };</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6CB6FF">  Map</span><span style="color:#ADBAC7">&lt;</span><span style="color:#6CB6FF">String</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">dynamic</span><span style="color:#ADBAC7">&gt; </span><span style="color:#DCBDFB">withTimeContext</span><span style="color:#ADBAC7">() </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">    ...</span><span style="color:#6CB6FF">this</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;time.hour&#x27;</span><span style="color:#F47067">:</span><span style="color:#6CB6FF"> DateTime</span><span style="color:#ADBAC7">.</span><span style="color:#DCBDFB">now</span><span style="color:#ADBAC7">().hour,</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;time.is_working_hours&#x27;</span><span style="color:#F47067">:</span><span style="color:#DCBDFB"> _isWorkingHours</span><span style="color:#ADBAC7">(),</span></span>
<span data-line=""><span style="color:#96D0FF">    &#x27;time.is_emergency_period&#x27;</span><span style="color:#F47067">:</span><span style="color:#DCBDFB"> _isEmergencyPeriod</span><span style="color:#ADBAC7">(),</span></span>
<span data-line=""><span style="color:#ADBAC7">  };</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<h2>策略即函数</h2>
<p>在即时义齿服务中，业务规则可以直接用函数表达：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="dart" data-theme="github-dark-dimmed"><code data-language="dart" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 基础策略函数</span></span>
<span data-line=""><span style="color:#6CB6FF">bool</span><span style="color:#DCBDFB"> isOrderOwner</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">Attributes</span><span style="color:#ADBAC7"> attrs) </span><span style="color:#F47067">=&gt;</span></span>
<span data-line=""><span style="color:#ADBAC7">  attrs[</span><span style="color:#96D0FF">&#x27;user.role&#x27;</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">==</span><span style="color:#96D0FF"> &#x27;clinic&#x27;</span><span style="color:#F47067"> &amp;&amp;</span></span>
<span data-line=""><span style="color:#ADBAC7">  attrs[</span><span style="color:#96D0FF">&#x27;user.clinic_id&#x27;</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">==</span><span style="color:#ADBAC7"> attrs[</span><span style="color:#96D0FF">&#x27;order.clinic_id&#x27;</span><span style="color:#ADBAC7">];</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6CB6FF">bool</span><span style="color:#DCBDFB"> isAssignedTechnician</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">Attributes</span><span style="color:#ADBAC7"> attrs) </span><span style="color:#F47067">=&gt;</span></span>
<span data-line=""><span style="color:#ADBAC7">  attrs[</span><span style="color:#96D0FF">&#x27;user.role&#x27;</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">==</span><span style="color:#96D0FF"> &#x27;technician&#x27;</span><span style="color:#F47067"> &amp;&amp;</span></span>
<span data-line=""><span style="color:#ADBAC7">  attrs[</span><span style="color:#96D0FF">&#x27;user.id&#x27;</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">==</span><span style="color:#ADBAC7"> attrs[</span><span style="color:#96D0FF">&#x27;order.assigned_technician&#x27;</span><span style="color:#ADBAC7">];</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6CB6FF">bool</span><span style="color:#DCBDFB"> canModifyDuringWorkHours</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">Attributes</span><span style="color:#ADBAC7"> attrs) </span><span style="color:#F47067">=&gt;</span></span>
<span data-line=""><span style="color:#ADBAC7">  attrs[</span><span style="color:#96D0FF">&#x27;time.is_working_hours&#x27;</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">||</span></span>
<span data-line=""><span style="color:#ADBAC7">  attrs[</span><span style="color:#96D0FF">&#x27;order.priority&#x27;</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">==</span><span style="color:#96D0FF"> &#x27;emergency&#x27;</span><span style="color:#ADBAC7">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6CB6FF">bool</span><span style="color:#DCBDFB"> isOrderInValidState</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">String</span><span style="color:#ADBAC7"> requiredState) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> (</span><span style="color:#6CB6FF">Attributes</span><span style="color:#ADBAC7"> attrs) </span><span style="color:#F47067">=&gt;</span></span>
<span data-line=""><span style="color:#ADBAC7">  attrs[</span><span style="color:#96D0FF">&#x27;order.status&#x27;</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">==</span><span style="color:#ADBAC7"> requiredState;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// 组合策略</span></span>
<span data-line=""><span style="color:#F47067">final</span><span style="color:#ADBAC7"> canEditServiceOrder </span><span style="color:#F47067">=</span><span style="color:#DCBDFB"> allOf</span><span style="color:#ADBAC7">([</span></span>
<span data-line=""><span style="color:#DCBDFB">  anyOf</span><span style="color:#ADBAC7">([</span></span>
<span data-line=""><span style="color:#ADBAC7">    isOrderOwner,</span></span>
<span data-line=""><span style="color:#DCBDFB">    allOf</span><span style="color:#ADBAC7">([</span></span>
<span data-line=""><span style="color:#ADBAC7">      (attrs) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> attrs[</span><span style="color:#96D0FF">&#x27;user.role&#x27;</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">==</span><span style="color:#96D0FF"> &#x27;coordinator&#x27;</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">      canModifyDuringWorkHours,</span></span>
<span data-line=""><span style="color:#ADBAC7">    ]),</span></span>
<span data-line=""><span style="color:#ADBAC7">  ]),</span></span>
<span data-line=""><span style="color:#DCBDFB">  isOrderInValidState</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">&#x27;pending&#x27;</span><span style="color:#ADBAC7">),</span></span>
<span data-line=""><span style="color:#ADBAC7">]);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">final</span><span style="color:#ADBAC7"> canAssignTechnician </span><span style="color:#F47067">=</span><span style="color:#DCBDFB"> allOf</span><span style="color:#ADBAC7">([</span></span>
<span data-line=""><span style="color:#ADBAC7">  (attrs) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> attrs[</span><span style="color:#96D0FF">&#x27;user.role&#x27;</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">==</span><span style="color:#96D0FF"> &#x27;coordinator&#x27;</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#DCBDFB">  isOrderInValidState</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">&#x27;pending&#x27;</span><span style="color:#ADBAC7">),</span></span>
<span data-line=""><span style="color:#ADBAC7">  canModifyDuringWorkHours,</span></span>
<span data-line=""><span style="color:#ADBAC7">]);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">final</span><span style="color:#ADBAC7"> canUpdateProgress </span><span style="color:#F47067">=</span><span style="color:#DCBDFB"> allOf</span><span style="color:#ADBAC7">([</span></span>
<span data-line=""><span style="color:#ADBAC7">  isAssignedTechnician,</span></span>
<span data-line=""><span style="color:#DCBDFB">  anyOf</span><span style="color:#ADBAC7">([</span></span>
<span data-line=""><span style="color:#DCBDFB">    isOrderInValidState</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">&#x27;assigned&#x27;</span><span style="color:#ADBAC7">),</span></span>
<span data-line=""><span style="color:#DCBDFB">    isOrderInValidState</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">&#x27;in_progress&#x27;</span><span style="color:#ADBAC7">),</span></span>
<span data-line=""><span style="color:#ADBAC7">  ]),</span></span>
<span data-line=""><span style="color:#ADBAC7">]);</span></span></code></pre></figure>
<p>在DentFlex项目中，这些规则直接反映了业务需求：诊所只能编辑自己创建的待处理订单，技师只能更新分配给自己的订单进度，协调员可以在工作时间内分配技师。</p>
<h2>柯里化：固化常用检查</h2>
<p>当我们有了通用的决策函数：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="dart" data-theme="github-dark-dimmed"><code data-language="dart" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#6CB6FF">Future</span><span style="color:#ADBAC7">&lt;(</span><span style="color:#6CB6FF">bool</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">String</span><span style="color:#ADBAC7">)&gt; </span><span style="color:#DCBDFB">evaluate</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#6CB6FF">  Type</span><span style="color:#ADBAC7"> resourceType,</span></span>
<span data-line=""><span style="color:#6CB6FF">  String</span><span style="color:#ADBAC7"> action,</span></span>
<span data-line=""><span style="color:#6CB6FF">  Attributes</span><span style="color:#ADBAC7"> attrs</span></span>
<span data-line=""><span style="color:#ADBAC7">) </span><span style="color:#F47067">async</span><span style="color:#ADBAC7"> { ... }</span></span></code></pre></figure>
<p>可以通过柯里化创建业务语义明确的检查函数：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="dart" data-theme="github-dark-dimmed"><code data-language="dart" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">final</span><span style="color:#ADBAC7"> canEditServiceOrder </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> (</span><span style="color:#6CB6FF">Attributes</span><span style="color:#ADBAC7"> attrs) </span><span style="color:#F47067">=&gt;</span></span>
<span data-line=""><span style="color:#DCBDFB">  evaluate</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">ServiceOrder</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">&#x27;edit&#x27;</span><span style="color:#ADBAC7">, attrs);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">final</span><span style="color:#ADBAC7"> canAssignTechnician </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> (</span><span style="color:#6CB6FF">Attributes</span><span style="color:#ADBAC7"> attrs) </span><span style="color:#F47067">=&gt;</span></span>
<span data-line=""><span style="color:#DCBDFB">  evaluate</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">ServiceOrder</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">&#x27;assign_technician&#x27;</span><span style="color:#ADBAC7">, attrs);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">final</span><span style="color:#ADBAC7"> canViewFinancialReport </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> (</span><span style="color:#6CB6FF">Attributes</span><span style="color:#ADBAC7"> attrs) </span><span style="color:#F47067">=&gt;</span></span>
<span data-line=""><span style="color:#DCBDFB">  evaluate</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">FinancialReport</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">&#x27;view&#x27;</span><span style="color:#ADBAC7">, attrs);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">final</span><span style="color:#ADBAC7"> canShareOrderDetails </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> (</span><span style="color:#6CB6FF">Attributes</span><span style="color:#ADBAC7"> attrs) </span><span style="color:#F47067">=&gt;</span></span>
<span data-line=""><span style="color:#DCBDFB">  evaluate</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">ServiceOrder</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">&#x27;share&#x27;</span><span style="color:#ADBAC7">, attrs);</span></span></code></pre></figure>
<p>这就像数学中的偏微分，固定部分变量，得到更简洁的函数形式。在处理即时义齿服务的各种操作时，调用者只需关心当前的属性上下文，而不用每次都指定资源类型和操作。</p>
<h2>摆脱组件的束缚</h2>
<p>传统ABAC架构中的PIP、PDP、PEP组件在函数式实现中自然融合：</p>
<ul>
<li><strong>PIP</strong> 变成了属性收集管道，从用户、订单、时间、地理位置等维度收集决策所需信息</li>
<li><strong>PDP</strong> 变成了策略函数组合，直接表达&quot;技师只能操作分配给自己的订单&quot;这类业务规则</li>
<li><strong>PEP</strong> 变成了权限检查的高阶函数，在UI层面控制按钮显示和操作权限</li>
</ul>
<p>组件边界消失了，但功能一个不少。就像即时义齿服务中的信息流，不再需要通过微信群这样的中介，直接在平台上流转，反而更加高效。</p>
<h2>实际效果</h2>
<p>在DentFlex项目中，这种实现方式带来了意想不到的好处：</p>
<p><strong>代码更简洁</strong>。订单状态变更、技师分配、进度更新等权限检查从原来的复杂配置缩减到一行函数调用。</p>
<p><strong>测试更容易</strong>。每个策略函数都是纯函数，可以轻松验证&quot;在非工作时间，协调员无法分配非紧急订单&quot;这类业务规则。</p>
<p><strong>扩展更灵活</strong>。当我们需要支持新的订单类型（比如种植牙修复服务），只需添加对应的策略函数，不需要修改任何现有代码。</p>
<p><strong>调试更清晰</strong>。可以清楚地看到为什么某个技师无法接受特定订单，或者为什么诊所无法修改已派发的订单。</p>
<h2>何时选择函数式ABAC</h2>
<p>并非所有场景都适合这种方式。如果你的系统已经有成熟的权限框架，或者需要复杂的审计和状态管理，传统组件化可能更合适。</p>
<p>但如果你在构建新系统，特别是涉及多角色协作的服务平台，函数式实现值得考虑。尤其是在以下场景：</p>
<ul>
<li>权限规则与业务状态紧密相关（如订单状态、服务时间）</li>
<li>多种角色需要灵活的权限组合</li>
<li>系统需要快速响应业务规则变化</li>
<li>团队更习惯声明式编程风格</li>
</ul>
<h2>结语</h2>
<p>回头看这个实现，有趣的是它并没有试图解决所有可能的权限控制问题。它只是忠实地映射了业务逻辑：订单有状态，用户有角色，操作有约束。函数式编程恰好提供了一种直接的表达方式。</p>
<p>传统ABAC架构的组件划分可能源于对复杂性的恐惧——通过明确的边界来控制不确定性。但在实际应用中，这些边界往往变成了束缚。函数组合的方式更像是数学证明：每一步都可以独立验证，整体逻辑自然呈现。</p>
<p>在DentFlex项目中，200行代码覆盖了所有权限场景。这个数字本身并不重要，重要的是代码的意图和实际功能之间几乎没有认知负担。当业务人员说&quot;技师只能操作分配给自己的订单&quot;时，代码中就有一个叫<code>isAssignedTechnician</code>的函数。</p>
<p>这种对应关系的建立，或许比任何架构模式都更有价值。毕竟，软件的最终目的是让复杂的现实世界变得可操作，而不是让操作变得复杂。</p></article><footer class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-700"><div class="flex justify-between items-center"><a class="text-sm text-gray-600 dark:text-gray-400 hover:text-pink-900 dark:hover:text-pink-100 transition-colors" href="/blog">← 返回博客列表</a><div class="flex items-center gap-2"><span class="text-sm text-gray-500 dark:text-gray-500">标签:</span><div class="flex gap-1"><span class="text-xs px-2 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded">ABAC</span><span class="text-xs px-2 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded">FP</span><span class="text-xs px-2 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded">权限控制</span></div></div></div></footer></article></div></div><!--$--><!--/$--><!--$--><!--/$--><script src="/_next/static/chunks/webpack-5788873a3947c2cc.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[7555,[],\"\"]\n3:I[1295,[],\"\"]\n5:I[9665,[],\"MetadataBoundary\"]\n7:I[9665,[],\"OutletBoundary\"]\na:I[4911,[],\"AsyncMetadataOutlet\"]\nc:I[9665,[],\"ViewportBoundary\"]\ne:I[6614,[],\"\"]\n:HL[\"/_next/static/media/569ce4b8f30dc480-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/7833d2e2b2ee9543-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/93f479601ee12b01-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/f30152c0704fba31.css\",\"style\"]\n:HL[\"/_next/static/css/0ae26d81c63a9da9.css\",\"style\"]\n:HL[\"/_next/static/css/c79e2679a18ceb00.css\",\"style\"]\n:HL[\"/_next/static/css/0e4ee5feb628e00d.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"xJpy2dv_-_gY86-KSWeOH\",\"p\":\"\",\"c\":[\"\",\"blog\",\"abac-fp\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"abac-fp\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/f30152c0704fba31.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/0ae26d81c63a9da9.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"2\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/c79e2679a18ceb00.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__variable_6d879b __variable_5cfdac __variable_9a8899 antialiased\",\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"slug\",\"abac-fp\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L4\",[\"$\",\"$L5\",null,{\"children\":\"$L6\"}],[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/0e4ee5feb628e00d.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L7\",null,{\"children\":[\"$L8\",\"$L9\",[\"$\",\"$La\",null,{\"promise\":\"$@b\"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"18JaYqyzPRvOt7vhzQNk2\",{\"children\":[[\"$\",\"$Lc\",null,{\"children\":\"$Ld\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],null]}],false]],\"m\":\"$undefined\",\"G\":[\"$e\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"f:\"$Sreact.suspense\"\n10:I[4911,[],\"AsyncMetadata\"]\n6:[\"$\",\"$f\",null,{\"fallback\":null,\"children\":[\"$\",\"$L10\",null,{\"promise\":\"$@11\"}]}]\n"])</script><script>self.__next_f.push([1,"13:I[6874,[\"874\",\"static/chunks/874-36030fac62063c21.js\",\"63\",\"static/chunks/63-5ad18c88ec2f5164.js\",\"953\",\"static/chunks/app/blog/%5Bslug%5D/page-ca6c25fdf74e0262.js\"],\"\"]\n9:null\n"])</script><script>self.__next_f.push([1,"4:[\"$\",\"div\",null,{\"className\":\"min-h-screen bg-background text-foreground\",\"children\":[\"$\",\"div\",null,{\"className\":\"max-w-2xl mx-auto px-4 py-12\",\"children\":[\"$\",\"article\",null,{\"children\":[\"$undefined\",[\"$\",\"header\",null,{\"className\":\"mb-12\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex flex-wrap gap-2 mb-6\",\"children\":[[\"$\",\"span\",\"ABAC\",{\"className\":\"text-xs px-3 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded-lg\",\"children\":\"ABAC\"}],[\"$\",\"span\",\"FP\",{\"className\":\"text-xs px-3 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded-lg\",\"children\":\"FP\"}],[\"$\",\"span\",\"权限控制\",{\"className\":\"text-xs px-3 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded-lg\",\"children\":\"权限控制\"}]]}],[\"$\",\"h1\",null,{\"className\":\"text-2xl md:text-4xl text-gray-900 dark:text-gray-100 mb-6 leading-tight\",\"children\":\"函数式编程实现ABAC：关于DentFlex的权限控制\"}],[\"$\",\"p\",null,{\"className\":\"font-light text-md text-gray-600 dark:text-gray-400 leading-relaxed mb-6 italic\",\"children\":\"探讨如何用函数式编程思维重新审视ABAC访问控制\"}],[\"$\",\"div\",null,{\"className\":\"flex items-center text-sm text-gray-500 dark:text-gray-500\",\"children\":[\"$\",\"time\",null,{\"dateTime\":\"2025-1-12\",\"children\":\"2025年1月12日\"}]}],[\"$\",\"div\",null,{\"className\":\"w-16 h-px bg-gray-300 dark:bg-gray-600 mt-8\"}]]}],[\"$\",\"article\",null,{\"className\":\"max-w-none prose prose-pink prose-img:rounded-lg prose-video:rounded-lg dark:prose-invert prose-a:text-foreground prose-a:decoration-6 prose-a:-underline-offset-2 prose-a:decoration-pink-300\",\"children\":\"$L12\"}],[\"$\",\"footer\",null,{\"className\":\"mt-16 pt-8 border-t border-gray-200 dark:border-gray-700\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex justify-between items-center\",\"children\":[[\"$\",\"$L13\",null,{\"href\":\"/blog\",\"className\":\"text-sm text-gray-600 dark:text-gray-400 hover:text-pink-900 dark:hover:text-pink-100 transition-colors\",\"children\":\"← 返回博客列表\"}],[\"$\",\"div\",null,{\"className\":\"flex items-center gap-2\",\"children\":[[\"$\",\"span\",null,{\"className\":\"text-sm text-gray-500 dark:text-gray-500\",\"children\":\"标签:\"}],[\"$\",\"div\",null,{\"className\":\"flex gap-1\",\"children\":[[\"$\",\"span\",\"ABAC\",{\"className\":\"text-xs px-2 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded\",\"children\":\"ABAC\"}],[\"$\",\"span\",\"FP\",{\"className\":\"text-xs px-2 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded\",\"children\":\"FP\"}],[\"$\",\"span\",\"权限控制\",{\"className\":\"text-xs px-2 py-1 bg-pink-100 dark:bg-pink-800 text-pink-600 dark:text-pink-400 rounded\",\"children\":\"权限控制\"}]]}]]}]]}]}]]}]}]}]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n8:null\n"])</script><script>self.__next_f.push([1,"11:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"函数式编程实现ABAC：关于DentFlex的权限控制 | 格物致知\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"探讨如何用函数式编程思维重新审视ABAC访问控制\"}],[\"$\",\"meta\",\"2\",{\"name\":\"keywords\",\"content\":\"ABAC,FP,权限控制\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:title\",\"content\":\"函数式编程实现ABAC：关于DentFlex的权限控制\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:description\",\"content\":\"探讨如何用函数式编程思维重新审视ABAC访问控制\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:type\",\"content\":\"article\"}],[\"$\",\"meta\",\"6\",{\"property\":\"article:published_time\",\"content\":\"2025-1-12\"}],[\"$\",\"meta\",\"7\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"8\",{\"name\":\"twitter:title\",\"content\":\"函数式编程实现ABAC：关于DentFlex的权限控制\"}],[\"$\",\"meta\",\"9\",{\"name\":\"twitter:description\",\"content\":\"探讨如何用函数式编程思维重新审视ABAC访问控制\"}]],\"error\":null,\"digest\":\"$undefined\"}\nb:{\"metadata\":\"$11:metadata\",\"error\":null,\"digest\":\"$undefined\"}\n"])</script><script>self.__next_f.push([1,"12:[[\"$\",\"p\",null,{\"children\":\"最近在开发DentFlex项目时，遇到了典型的权限控制场景。这是一个为即时义齿服务设计的数字平台，涉及牙科诊所、技师、服务协调员等多个角色，需要对外派服务订单、财务报表等资源进行精细化访问控制。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"在传统的牙科义齿制作流程中，当患者需要种植牙时，牙医必须先拔除剩余牙齿并植入基台。在这个过渡期间，制造商会派遣技师提供即时临时义齿制作服务。过去这种协调主要依赖微信等非正式沟通渠道，效率低下且容易出错。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"DentFlex要解决的就是这种混乱的协调问题。但随之而来的权限控制需求让我重新思考了ABAC的实现方式。\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"复杂的权限需求\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"在即时义齿服务场景中，权限控制远比简单的角色分配复杂：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"牙科诊所\"}],\"可以创建服务请求，查看自己的订单状态，但不能修改已派发的订单\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"技师\"}],\"可以接受指派，更新服务进度，上传完成照片，但只能操作分配给自己的订单\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"服务协调员\"}],\"可以分配技师，修改订单状态，查看所有财务数据，但某些操作需要在工作时间内进行\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"制造商管理员\"}],\"拥有最高权限，但对敏感财务数据的访问需要额外验证\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"传统的RBAC显然不够用。权限不仅取决于用户角色，还与订单状态、时间、地理位置等多种因素相关。比如技师只能在订单状态为\\\"已派发\\\"时接受任务，服务协调员只能在工作时间调整高优先级订单。\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"重新审视ABAC的本质\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"看了一圈现有的ABAC实现方案，那些PIP、PDP、PEP组件让人眼花缭乱，静下心来想想，ABAC的核心其实很简单：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"决策 = f(用户属性, 资源属性, 环境属性, 操作属性)\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"这是一个纯函数，输入明确，输出确定，没有副作用。既然如此，为什么不直接用函数式编程来实现？\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"传统的组件化方式把这个简单的函数拆成了若干个类和接口，然后再把它们组合起来。就像把一个完整的服务订单切成片，装进不同的盒子里，最后再拼回去。\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"属性收集：管道代替组件\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"在传统ABAC中，PIP（策略信息点）负责收集属性。用函数式思维，这就是一个数据转换管道：\"}],\"\\n\",[\"$\",\"figure\",null,{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",null,{\"style\":{\"backgroundColor\":\"#22272e\",\"color\":\"#adbac7\"},\"tabIndex\":\"0\",\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"children\":[\"$\",\"code\",null,{\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Future\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003c\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003e \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"collectServiceOrderAttributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"  User\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" user,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"  ServiceOrder\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" order\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\") \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"async\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"  return\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" {}\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"    .\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"withUser\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(user)\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"    .\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"withServiceOrder\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(order)\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"    .\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"withTimeContext\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"()\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"    .\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"withLocationContext\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"();\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"每个步骤都是一个纯函数，接收属性字典，返回增强后的字典。就像流水线一样，数据流经每个工站，逐步被加工完善。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"在DentFlex中，我们需要根据用户角色、订单状态、服务时间、技师位置等因素来决定权限。这些属性散布在不同的数据源中，用管道模式可以优雅地组合它们：\"}],\"\\n\",[\"$\",\"figure\",null,{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",null,{\"style\":{\"backgroundColor\":\"#22272e\",\"color\":\"#adbac7\"},\"tabIndex\":\"0\",\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"children\":[\"$\",\"code\",null,{\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"extension\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\" AttributePipeline\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\" on\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\" Map\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003c\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"String\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"dynamic\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003e {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"  Map\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003c\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"String\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"dynamic\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003e \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"withUserRole\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"User\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" user) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"    ...\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"this\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'user.role'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" user.role, \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#768390\"},\"children\":\"// 'clinic', 'technician', 'coordinator', 'admin'\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'user.region'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" user.assignedRegion,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'user.certification'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" user.certificationLevel,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  };\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"  Map\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003c\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"String\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"dynamic\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003e \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"withServiceOrder\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"ServiceOrder\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" order) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"    ...\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"this\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'order.status'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" order.status, \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#768390\"},\"children\":\"// 'pending', 'assigned', 'in_progress', 'completed'\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'order.priority'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" order.priority,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'order.clinic_id'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" order.clinicId,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'order.assigned_technician'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" order.assignedTechnicianId,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'order.created_at'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" order.createdAt,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  };\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"  Map\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003c\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"String\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"dynamic\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003e \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"withTimeContext\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"() \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"    ...\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"this\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'time.hour'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\" DateTime\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\".\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"now\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"().hour,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'time.is_working_hours'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\" _isWorkingHours\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(),\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"    'time.is_emergency_period'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\" _isEmergencyPeriod\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(),\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  };\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"策略即函数\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"在即时义齿服务中，业务规则可以直接用函数表达：\"}],\"\\n\",[\"$\",\"figure\",null,{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",null,{\"style\":{\"backgroundColor\":\"#22272e\",\"color\":\"#adbac7\"},\"tabIndex\":\"0\",\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"children\":[\"$\",\"code\",null,{\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#768390\"},\"children\":\"// 基础策略函数\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"bool\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\" isOrderOwner\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'user.role'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\" 'clinic'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\" \u0026\u0026\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'user.clinic_id'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'order.clinic_id'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"];\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"bool\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\" isAssignedTechnician\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'user.role'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\" 'technician'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\" \u0026\u0026\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'user.id'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'order.assigned_technician'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"];\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"bool\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\" canModifyDuringWorkHours\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'time.is_working_hours'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"||\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'order.priority'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\" 'emergency'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\";\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"bool\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\" isOrderInValidState\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"String\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" requiredState) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" (\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'order.status'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" requiredState;\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#768390\"},\"children\":\"// 组合策略\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"final\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" canEditServiceOrder \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\" allOf\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"([\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"  anyOf\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"([\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"    isOrderOwner,\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"    allOf\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"([\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"      (attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'user.role'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\" 'coordinator'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"      canModifyDuringWorkHours,\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"    ]),\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  ]),\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"  isOrderInValidState\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'pending'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"),\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"]);\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"final\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" canAssignTechnician \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\" allOf\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"([\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  (attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'user.role'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\" 'coordinator'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"  isOrderInValidState\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'pending'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"),\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  canModifyDuringWorkHours,\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"]);\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"final\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" canUpdateProgress \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\" allOf\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"([\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  isAssignedTechnician,\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"  anyOf\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"([\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"    isOrderInValidState\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'assigned'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"),\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"    isOrderInValidState\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'in_progress'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"),\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"  ]),\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"]);\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"在DentFlex项目中，这些规则直接反映了业务需求：诊所只能编辑自己创建的待处理订单，技师只能更新分配给自己的订单进度，协调员可以在工作时间内分配技师。\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"柯里化：固化常用检查\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"当我们有了通用的决策函数：\"}],\"\\n\",[\"$\",\"figure\",null,{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",null,{\"style\":{\"backgroundColor\":\"#22272e\",\"color\":\"#adbac7\"},\"tabIndex\":\"0\",\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"children\":[\"$\",\"code\",null,{\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Future\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"\u003c(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"bool\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"String\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\")\u003e \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"evaluate\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"  Type\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" resourceType,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"  String\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" action,\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"  Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\") \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"async\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" { ... }\"}]]}]]}]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"可以通过柯里化创建业务语义明确的检查函数：\"}],\"\\n\",[\"$\",\"figure\",null,{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",null,{\"style\":{\"backgroundColor\":\"#22272e\",\"color\":\"#adbac7\"},\"tabIndex\":\"0\",\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"children\":[\"$\",\"code\",null,{\"data-language\":\"dart\",\"data-theme\":\"github-dark-dimmed\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"final\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" canEditServiceOrder \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" (\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"  evaluate\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"ServiceOrder\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'edit'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", attrs);\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"final\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" canAssignTechnician \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" (\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"  evaluate\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"ServiceOrder\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'assign_technician'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", attrs);\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"final\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" canViewFinancialReport \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" (\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"  evaluate\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"FinancialReport\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'view'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", attrs);\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"final\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" canShareOrderDetails \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" (\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"Attributes\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\" attrs) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F47067\"},\"children\":\"=\u003e\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#DCBDFB\"},\"children\":\"  evaluate\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6CB6FF\"},\"children\":\"ServiceOrder\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#96D0FF\"},\"children\":\"'share'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#ADBAC7\"},\"children\":\", attrs);\"}]]}]]}]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"这就像数学中的偏微分，固定部分变量，得到更简洁的函数形式。在处理即时义齿服务的各种操作时，调用者只需关心当前的属性上下文，而不用每次都指定资源类型和操作。\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"摆脱组件的束缚\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"传统ABAC架构中的PIP、PDP、PEP组件在函数式实现中自然融合：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"PIP\"}],\" 变成了属性收集管道，从用户、订单、时间、地理位置等维度收集决策所需信息\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"PDP\"}],\" 变成了策略函数组合，直接表达\\\"技师只能操作分配给自己的订单\\\"这类业务规则\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"PEP\"}],\" 变成了权限检查的高阶函数，在UI层面控制按钮显示和操作权限\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"组件边界消失了，但功能一个不少。就像即时义齿服务中的信息流，不再需要通过微信群这样的中介，直接在平台上流转，反而更加高效。\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"实际效果\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"在DentFlex项目中，这种实现方式带来了意想不到的好处：\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"代码更简洁\"}],\"。订单状态变更、技师分配、进度更新等权限检查从原来的复杂配置缩减到一行函数调用。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"测试更容易\"}],\"。每个策略函数都是纯函数，可以轻松验证\\\"在非工作时间，协调员无法分配非紧急订单\\\"这类业务规则。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"扩展更灵活\"}],\"。当我们需要支持新的订单类型（比如种植牙修复服务），只需添加对应的策略函数，不需要修改任何现有代码。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"调试更清晰\"}],\"。可以清楚地看到为什么某个技师无法接受特定订单，或者为什么诊所无法修改已派发的订单。\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"何时选择函数式ABAC\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"并非所有场景都适合这种方式。如果你的系统已经有成熟的权限框架，或者需要复杂的审计和状态管理，传统组件化可能更合适。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"但如果你在构建新系统，特别是涉及多角色协作的服务平台，函数式实现值得考虑。尤其是在以下场景：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"权限规则与业务状态紧密相关（如订单状态、服务时间）\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"多种角色需要灵活的权限组合\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"系统需要快速响应业务规则变化\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"团队更习惯声明式编程风格\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"结语\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"回头看这个实现，有趣的是它并没有试图解决所有可能的权限控制问题。它只是忠实地映射了业务逻辑：订单有状态，用户有角色，操作有约束。函数式编程恰好提供了一种直接的表达方式。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"传统ABAC架构的组件划分可能源于对复杂性的恐惧——通过明确的边界来控制不确定性。但在实际应用中，这些边界往往变成了束缚。函数组合的方式更像是数学证明：每一步都可以独立验证，整体逻辑自然呈现。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"在DentFlex项目中，200行代码覆盖了所有权限场景。这个数字本身并不重要，重要的是代码的意图和实际功能之间几乎没有认知负担。当业务人员说\\\"技师只能操作分配给自己的订单\\\"时，代码中就有一个叫\",[\"$\",\"code\",null,{\"children\":\"isAssignedTechnician\"}],\"的函数。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"这种对应关系的建立，或许比任何架构模式都更有价值。毕竟，软件的最终目的是让复杂的现实世界变得可操作，而不是让操作变得复杂。\"}]]\n"])</script></body></html>